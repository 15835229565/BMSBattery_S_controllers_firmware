CC = /home/cas/software/stm8-binutils/bin/sdcc

PLATFORM = stm8

PNAME = main

SIZE = size
HEX2BIN = hex2bin

ODIR_BIN = build/bin

IDIR = StdPeriphLib/inc
SDIR = StdPeriphLib/src

MAINSRC = $(PNAME).c

INCLUDES = -I$(IDIR) -I. 
CFLAGS   = -m$(PLATFORM) -I/usr/local/share/sdcc/include -I/usr/local/share/sdcc/lib/ --std-c99 --nolospre
IHX_FLAGS = --out-fmt-ihx
LIBS     = -l$(PLATFORM)

all: $(PNAME)

$(PNAME): $(MAINSRC) src
	$(CC) $(INCLUDES) $(CFLAGS) $(IHX_FLAGS) $(LIBS) $(MAINSRC) \
	$(ODIR_BIN)/stm8s_itc.rel \
	$(ODIR_BIN)/stm8s_clk.rel \
	$(ODIR_BIN)/stm8s_gpio.rel \
	$(ODIR_BIN)/stm8s_exti.rel \
	$(ODIR_BIN)/stm8s_uart2.rel \
	$(ODIR_BIN)/stm8s_tim1.rel \
	$(ODIR_BIN)/stm8s_tim2.rel \
	$(ODIR_BIN)/stm8s_adc1.rel \
	$(ODIR_BIN)/gpio.rel \
	$(ODIR_BIN)/cruise_control.rel \
	$(ODIR_BIN)/motor.rel \
	$(ODIR_BIN)/uart.rel \
	-o$(ODIR_BIN)/
	$(HEX2BIN) -p 00 $(ODIR_BIN)/$(PNAME).ihx

src:
	$(CC) -c $(INCLUDES) $(CFLAGS) $(IHX_FLAGS) $(LIBS) -o$(ODIR_BIN)/stm8s_itc.c $(SDIR)/stm8s_itc.c
	$(CC) -c $(INCLUDES) $(CFLAGS) $(IHX_FLAGS) $(LIBS) -o$(ODIR_BIN)/stm8s_clk.c $(SDIR)/stm8s_clk.c
	$(CC) -c $(INCLUDES) $(CFLAGS) $(IHX_FLAGS) $(LIBS) -o$(ODIR_BIN)/stm8s_gpio.c $(SDIR)/stm8s_gpio.c
	$(CC) -c $(INCLUDES) $(CFLAGS) $(IHX_FLAGS) $(LIBS) -o$(ODIR_BIN)/stm8s_exti.c $(SDIR)/stm8s_exti.c
	$(CC) -c $(INCLUDES) $(CFLAGS) $(IHX_FLAGS) $(LIBS) -o$(ODIR_BIN)/stm8s_uart2.c $(SDIR)/stm8s_uart2.c
	$(CC) -c $(INCLUDES) $(CFLAGS) $(IHX_FLAGS) $(LIBS) -o$(ODIR_BIN)/stm8s_tim1.c $(SDIR)/stm8s_tim1.c
	$(CC) -c $(INCLUDES) $(CFLAGS) $(IHX_FLAGS) $(LIBS) -o$(ODIR_BIN)/stm8s_tim2.c $(SDIR)/stm8s_tim2.c
	$(CC) -c $(INCLUDES) $(CFLAGS) $(IHX_FLAGS) $(LIBS) -o$(ODIR_BIN)/stm8s_adc1.c $(SDIR)/stm8s_adc1.c
	$(CC) -c $(INCLUDES) $(CFLAGS) $(IHX_FLAGS) $(LIBS) -o$(ODIR_BIN)/gpio.c gpio.c
	$(CC) -c $(INCLUDES) $(CFLAGS) $(IHX_FLAGS) $(LIBS) -o$(ODIR_BIN)/cruise_control.c cruise_control.c
	$(CC) -c $(INCLUDES) $(CFLAGS) $(IHX_FLAGS) $(LIBS) -o$(ODIR_BIN)/motor.c motor.c
	$(CC) -c $(INCLUDES) $(CFLAGS) $(IHX_FLAGS) $(LIBS) -o$(ODIR_BIN)/uart.c uart.c


#	@echo $<

clean:
	@echo "Removing $(ODIR_BIN)..."
	@rm -rf $(ODIR_BIN)
	@mkdir -p build
	@mkdir -p build/bin
	@echo "Done."

