NAME=main
SDCC=sdcc

#CCFLAGS=-DSTM8S105 -I../  -I/usr/share/sdcc/include -mstm8 --out-fmt-elf --all-callee-saves --debug --verbose --stack-auto --fverbose-asm  --float-reent --no-peep
CCFLAGS= -DSTM8S003 -I../  -I/usr/share/sdcc/include -mstm8 --out-fmt-elf --all-callee-saves --debug --verbose --stack-auto --fverbose-asm  --float-reent --no-peep
LDFLAGS= -mstm8 --out-fmt-ihx
FLASHFLAGS=-cstlinkv2 -pstm8s105

CCFLAGS_ELF = -DSTM8S003 -I../  -I/usr/share/sdcc/include -mstm8 --out-fmt-elf
LDFLAGS_ELF = -mstm8 --out-fmt-elf

SRC=$(wildcard *.c)
# ATTENTION: FIRST in list should be file with main()
OBJ=$(SRC:%.c=%.rel)

OBJ_ELF=$(SRC:%.c=%.rel)

TRASH=$(OBJ) $(SRC:%.c=%.rst) $(SRC:%.c=%.asm) $(SRC:%.c=%.lst)
TRASH+=$(SRC:%.c=%.sym) $(NAME).bin $(NAME).elf $(NAME).ihx $(NAME).lk $(NAME).map
TRASH+=main.cdb
INDEPENDENT_HEADERS=../stm8l.h Makefile

all: $(NAME).ihx

elf: $(NAME).elf

$(SRC) : %.c : %.h $(INDEPENDENT_HEADERS)
	@touch $@
	@echo $@

%.h: ;

clean:
	rm -f $(TRASH)

load: $(NAME).ihx
	stm8flash $(FLASHFLAGS) -wf $(NAME).bin

%.rel: %.c
	$(SDCC) $(CCFLAGS) -c $<

%.rel_ELF: %.c
	$(SDCC) $(CCFLAGS_ELF) -c $<

$(NAME).ihx: $(OBJ)
	$(SDCC) $(LDFLAGS) $(OBJ) -o $(NAME).ihx
	objcopy -Iihex -Obinary $(NAME).ihx $(NAME).bin
	size $(NAME).ihx

$(NAME).elf: $(OBJ_ELF)
	$(SDCC) $(LDFLAGS_ELF) $(OBJ_ELF) -o $(NAME).elf
	objcopy -Iihex -Obinary $(NAME).elf $(NAME).bin
	size $(NAME).elf

.PHONY: all
